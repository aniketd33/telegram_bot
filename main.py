from aiogram import Bot, Dispatcher, executor, types
from groq import Groq
import sys 
import os 
from dotenv import load_dotenv

load_dotenv()

client = Groq(api_key=os.getenv("GROQ_API_KEY"))
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

class Reference:
    """
    A class to store previously response from the 
    Groq API
    """

    def __init__(self)-> None:
        self.response = ""

    
reference = Reference()

model_name = "llama-3.3-70b-versatile"

bot = Bot(token=TELEGRAM_BOT_TOKEN)
dispatcher = Dispatcher(bot)

def clear_past():
    """
    Clear the past response from the reference object
    """
    reference.response = ""


@dispatcher.message_handler(commands=['clear'])
async def clear(message: types.Message):
    """
    Handler function to clear the past response from the reference object
    """
    clear_past()
    await message.reply("Cleared past response")



@dispatcher.message_handler(commands=['start'])
async def welcome(message: types.Message):
    """
    This handler receives messages with `/start`
    """
    await message.reply("Hi\nI am Tele Bot!\Created by Bappy. How can i assist you?")


@dispatcher.message_handler(commands=['help'])
async def helper(message: types.Message):
    """
    A handler to display the help menu.
    """
    help_command = """
    Hi There, I'm Telegram bot created by Bappy! Please follow these commands - 
    /start - to start the conversation
    /clear - to clear the past conversation and context.
    /help - to get this help menu.
    I hope this helps. :)
    """
    await message.reply(help_command)



@dispatcher.message_handler()
async def chatgpt(message: types.Message):
    """
    A handler to process the user's input and generate a response using the Groq API.
    """

    print(f">>> User: \n\t {message.text}")
    response = client.chat.completions.create(
        model = model_name,
        messages = [
            {"role": "assistant", "content": reference.response}, # role assistant
            {"role": "user", "content": message.text} #our query 
  
        ]
    )

    reference.response = response.choices[0].message.content
    print(f">>> Groq: \n\t{reference.response}")
    await bot.send_message(chat_id = message.chat.id, text = reference.response)



if __name__ == '__main__':
    executor.start_polling(dispatcher, skip_updates=False)